<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUKOPS BABINSA - Sistem Pelaporan</title>
    <meta name="theme-color" content="#202624">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <link rel="manifest" href="site.webmanifest" />
    
    <!-- Styles & Scripts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #101415; color: #f5f5f5; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: #202624; padding: 20px; border-radius: 10px; border: 2px solid #3a4f41; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #3a4f41; }
        .header img { height: 120px; width: 120px; border: 1px solid #3a4f41; border-radius: 5px; }
        .header-text { flex: 1; }
        .title { font-size: 16px; font-weight: bold; color: #b2d8b2; }
        .subtitle { font-size: 12px; color: #9fd49f; margin-top: 5px; }
        .counter { font-size: 60px; font-weight: bold; color: #9fd49f; text-align: center; margin: 10px 0; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #b2d8b2; }
        select, input, textarea, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: none; font-size: 16px; }
        select, input, textarea { background: #333; color: white; }
        textarea { min-height: 100px; resize: vertical; }
        button { background: #2b4d2b; color: white; font-weight: bold; cursor: pointer; margin-top: 20px; }
        button:hover { background: #3e704a; }
        button:disabled { background: #555; cursor: not-allowed; }
        canvas { width: 100%; margin-top: 20px; border: 1px solid #444; background: black; }
        .preview { font-size: 14px; color: #aaa; margin-top: 5px; min-height: 20px; }
        .notification { position: fixed; bottom: 20px; left: 20px; right: 20px; background: #4CAF50; color: white; padding: 15px; border-radius: 5px; text-align: center; z-index: 1000; }
        .notification.error { background: #f44336; }
        .notification.warning { background: #FF9800; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img id="desaHeaderImage" src="https://github.com/Koramil05/DUKOPS/raw/main/bnr_default.png" alt="Logo Desa">
            <div class="header-text">
                <div class="title">DUKOPS BABINSA</div>
                <div class="title">KORAMIL 1609-05/SUKASADA</div>
                <div class="subtitle">Jl. Jelantik Gingsir No. 32 Sukasada Singaraja-Bali 81161</div>
                <div class="counter" id="submissionCounter">0</div>
            </div>
        </div>
        
        <label><i class="fas fa-village"></i> Pilih Desa:</label>
        <select id="selectDesa">
            <option value="">-- Pilih Desa --</option>
        </select>
        <div class="preview" id="previewDesa"></div>
        
        <label><i class="fas fa-map-marker-alt"></i> Koordinat:</label>
        <div class="preview" id="previewKordinat">Pilih desa terlebih dahulu</div>
        
        <label><i class="fas fa-camera"></i> Foto Kegiatan:</label>
        <input type="file" id="gambar" accept="image/*">
        <div class="preview" id="previewGambar"></div>
        
        <label><i class="fas fa-calendar-alt"></i> Tanggal & Waktu:</label>
        <input type="datetime-local" id="tanggalWaktu">
        <div class="preview" id="previewTanggal"></div>
        
        <label><i class="fas fa-file-alt"></i> Narasi Kegiatan:</label>
        <textarea id="narasi" placeholder="Masukkan narasi kegiatan..."></textarea>
        
        <canvas id="canvas"></canvas>
        
        <button id="submitBtn" disabled>
            <i class="fas fa-download"></i> DOWNLOAD & <i class="fas fa-paper-plane"></i> KIRIM & <i class="fab fa-google-drive"></i> DRIVE
        </button>
        
        <button id="showReportBtn">
            <i class="fas fa-chart-bar"></i> TAMPILKAN LAPORAN
        </button>
        
        <div id="reportPanel" style="display: none; margin-top: 20px; padding: 15px; background: #1d1f1d; border-radius: 5px;">
            <h3><i class="fas fa-file-alt"></i> LAPORAN TERKIRIM</h3>
            <div id="reportList"></div>
        </div>
        
        <div id="logTerkirim" style="margin-top: 20px; padding: 10px; background: #1d1f1d; border-radius: 5px; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <script>
        // CONFIG
        const GITHUB_API_URL = "https://api.github.com/repos/Koramil05/DUKOPS/contents/";
        const GOOGLE_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbweib5g7YBnC5XuguK2LTEOCPOXa3dttgATlegVtdeEU1LmcoWA1RGsxOWqeVTDoXjn/exec";
        
        // Variables
        let selectedDesa = "";
        let kordinatList = [];
        let currentKoordinat = "";
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDesaList();
            setupDateTime();
            setupEventListeners();
        });
        
        // Load desa list from GitHub
        async function loadDesaList() {
            try {
                const response = await fetch(GITHUB_API_URL);
                const files = await response.json();
                const select = document.getElementById('selectDesa');
                
                files.forEach(file => {
                    if (file.name.startsWith('CO_') && file.name.endsWith('.txt')) {
                        const desaName = file.name.replace('CO_', '').replace('.txt', '').replace(/_/g, ' ');
                        const option = document.createElement('option');
                        option.value = file.download_url;
                        option.textContent = desaName;
                        select.appendChild(option);
                    }
                });
                
                select.addEventListener('change', async function() {
                    selectedDesa = this.options[this.selectedIndex].text;
                    document.getElementById('previewDesa').textContent = "Desa: " + selectedDesa;
                    
                    // Load coordinates
                    if (this.value) {
                        try {
                            const coordResponse = await fetch(this.value);
                            const text = await coordResponse.text();
                            kordinatList = text.split('\n').filter(line => line.includes(','));
                            pickRandomKoordinat();
                        } catch (error) {
                            showNotification("Gagal memuat koordinat", "error");
                        }
                    }
                });
                
            } catch (error) {
                showNotification("Gagal memuat daftar desa", "error");
            }
        }
        
        function pickRandomKoordinat() {
            if (kordinatList.length > 0) {
                const randomIndex = Math.floor(Math.random() * kordinatList.length);
                currentKoordinat = kordinatList[randomIndex];
                document.getElementById('previewKordinat').textContent = currentKoordinat;
            }
            checkInputCompletion();
        }
        
        function setupDateTime() {
            const now = new Date();
            const dateInput = document.getElementById('tanggalWaktu');
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            dateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            updateDatePreview();
            
            dateInput.addEventListener('change', updateDatePreview);
        }
        
        function updateDatePreview() {
            const date = new Date(document.getElementById('tanggalWaktu').value);
            document.getElementById('previewTanggal').textContent = date.toLocaleString('id-ID');
            checkInputCompletion();
        }
        
        function setupEventListeners() {
            // Image preview
            document.getElementById('gambar').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('previewGambar').textContent = file.name;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = function() {
                            drawCanvas(img);
                            checkInputCompletion();
                        };
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Narasi input
            document.getElementById('narasi').addEventListener('input', checkInputCompletion);
            
            // Submit button
            document.getElementById('submitBtn').addEventListener('click', processSubmission);
            
            // Report button
            document.getElementById('showReportBtn').addEventListener('click', function() {
                const panel = document.getElementById('reportPanel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                if (panel.style.display === 'block') loadReports();
            });
        }
        
        function drawCanvas(img) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 800;
            canvas.height = canvas.width * (img.height / img.width);
            
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // Add watermark
            ctx.fillStyle = 'white';
            ctx.font = '30px Arial';
            ctx.textAlign = 'right';
            
            if (selectedDesa) {
                ctx.fillText("Babinsa " + selectedDesa, canvas.width - 20, canvas.height - 80);
            }
            if (currentKoordinat) {
                ctx.fillText(currentKoordinat, canvas.width - 20, canvas.height - 40);
            }
            
            const date = new Date(document.getElementById('tanggalWaktu').value);
            ctx.fillText(date.toLocaleString('id-ID'), canvas.width - 20, canvas.height - 10);
        }
        
        function checkInputCompletion() {
            const hasDesa = selectedDesa !== "";
            const hasKoordinat = currentKoordinat !== "";
            const hasGambar = document.getElementById('gambar').files.length > 0;
            const hasNarasi = document.getElementById('narasi').value.trim() !== "";
            
            document.getElementById('submitBtn').disabled = !(hasDesa && hasKoordinat && hasGambar && hasNarasi);
        }
        
        async function processSubmission() {
            if (!confirm("Kirim laporan untuk " + selectedDesa + "?")) return;
            
            const button = document.getElementById('submitBtn');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
            
            try {
                // Get canvas image
                const canvas = document.getElementById('canvas');
                const imageData = canvas.toDataURL('image/png');
                
                // Prepare data
                const date = new Date(document.getElementById('tanggalWaktu').value);
                const day = String(date.getDate()).padStart(2, '0');
                const monthNum = String(date.getMonth() + 1);
                const monthName = date.toLocaleDateString('id-ID', { month: 'long' });
                const year = date.getFullYear();
                
                const zip = new JSZip();
                
                // Add files to zip
                const narasiContent = `${date.toLocaleString('id-ID')}\tBabinsa ${selectedDesa}\t${document.getElementById('narasi').value}`;
                zip.file(`${selectedDesa} ${day} ${monthName} ${year} Narasi.txt`, narasiContent);
                
                const imageBase64 = imageData.split(',')[1];
                zip.file(`${selectedDesa} ${day} ${monthName} ${year} Dukops.png`, imageBase64, { base64: true });
                
                // Generate zip
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const zipFileName = `${selectedDesa} ${day} ${monthNum} ${year}.zip`;
                
                // 1. Download locally
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(zipBlob);
                downloadLink.download = zipFileName;
                downloadLink.click();
                
                // 2. Convert to base64 for backend
                const reader = new FileReader();
                reader.onloadend = async function() {
                    const base64Data = reader.result.split(',')[1];
                    
                    // Send to Google Apps Script
                    const formData = new FormData();
                    formData.append('action', 'sendTelegram');
                    formData.append('fileName', zipFileName);
                    formData.append('desaName', selectedDesa);
                    formData.append('fileData', base64Data);
                    formData.append('mimeType', 'application/zip');
                    
                    try {
                        const response = await fetch(GOOGLE_APPS_SCRIPT, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showNotification("✅ Berhasil dikirim ke Telegram & Drive", "success");
                            updateCounter();
                            addToLog(zipFileName, "success");
                        } else {
                            showNotification("⚠ Berhasil download, tapi gagal ke Telegram", "warning");
                            addToLog(zipFileName, "warning");
                        }
                    } catch (error) {
                        showNotification("❌ Gagal mengirim ke server", "error");
                        addToLog(zipFileName, "error");
                    }
                };
                reader.readAsDataURL(zipBlob);
                
            } catch (error) {
                console.error(error);
                showNotification("❌ Terjadi kesalahan", "error");
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-download"></i> DOWNLOAD & <i class="fas fa-paper-plane"></i> KIRIM & <i class="fab fa-google-drive"></i> DRIVE';
            }
        }
        
        function updateCounter() {
            const counter = document.getElementById('submissionCounter');
            let count = parseInt(counter.textContent) || 0;
            counter.textContent = count + 1;
        }
        
        function addToLog(filename, status) {
            const logDiv = document.getElementById('logTerkirim');
            const logEntry = document.createElement('div');
            logEntry.style.padding = '5px';
            logEntry.style.margin = '5px 0';
            logEntry.style.background = status === 'success' ? '#2a3a2e' : '#3a2a2a';
            logEntry.style.borderRadius = '3px';
            
            const time = new Date().toLocaleTimeString('id-ID');
            logEntry.innerHTML = `<small>${time}</small> | ${filename} | <strong>${status.toUpperCase()}</strong>`;
            
            logDiv.insertBefore(logEntry, logDiv.firstChild);
        }
        
        async function loadReports() {
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT + '?action=listFiles');
                const result = await response.json();
                
                if (result.success) {
                    const reportList = document.getElementById('reportList');
                    reportList.innerHTML = '';
                    
                    if (result.files && result.files.length > 0) {
                        result.files.forEach(file => {
                            const div = document.createElement('div');
                            div.style.padding = '10px';
                            div.style.margin = '5px 0';
                            div.style.background = '#2a3a2e';
                            div.style.borderRadius = '5px';
                            
                            const date = new Date(file.createdTime).toLocaleDateString('id-ID');
                            div.innerHTML = `
                                <strong>${file.name}</strong><br>
                                <small>Desa: ${file.desa} | ${date} | ${Math.round(file.size/1024)} KB</small>
                            `;
                            
                            reportList.appendChild(div);
                        });
                    } else {
                        reportList.innerHTML = '<p style="text-align: center; color: #aaa;">Belum ada laporan</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>