<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- PWA Configuration -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DUKOPS">
    <title>Sistem Pelaporan DUKOPS BABINSA</title>
    <meta name="theme-color" content="#202624">
    
    <!-- ========== FAVICON ========== -->
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <link rel="manifest" href="site.webmanifest" />
    <!-- ============================= -->
    
    <!-- External Libraries -->
    <script src="https://cdn.polyfill.io/v3/polyfill.min.js?features=default,es6,Promise,fetch,Array.prototype.includes"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #101415; color: #f5f5f5; padding: 20px; line-height: 1.5; }
        .container { max-width: 600px; margin: auto; background: #202624; padding: 20px; border-radius: 10px; border: 2px solid #3a4f41; }
        .header-container { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #3a4f41; }
        .header-image { height: 150px; width: 150px; border: 1px solid #3a4f41; border-radius: 5px; object-fit: contain; }
        .header-text { flex: 1; min-width: 0; }
        .header-title { font-size: 16px; font-weight: bold; color: #b2d8b2; line-height: 1.3; }
        .header-subtitle { font-size: 12px; margin-top: 5px; color: #9fd49f; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #b2d8b2; }
        select, input, textarea { width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: none; background: #333; color: #f5f5f5; font-size: 16px; }
        textarea { min-height: 100px; resize: vertical; }
        button { margin-top: 20px; padding: 12px 15px; background: #2b4d2b; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; }
        button:hover:not(:disabled) { background: #3e704a; }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
        canvas { display: block; margin-top: 20px; width: 100%; height: auto; border: 1px solid #444; background: #000; }
        .previewBox { font-size: 14px; color: #a5a5a5; margin-top: 5px; min-height: 1em; }
        #logTerkirim { background: #1d1f1d; padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto; font-size: 14px; margin-top: 15px; }
        .counter-value { font-size: 60px; font-weight: bold; color: #9fd49f; }
        .log-entry { background: #2a3a2e; padding: 8px; margin: 5px 0; border-radius: 5px; font-size: 13px; }
        .log-time { color: #b2d8b2; font-size: 12px; }
        .log-filename { font-weight: bold; color: #9fd49f; }
        .notification { position: fixed; bottom: 20px; right: 20px; left: 20px; padding: 12px 15px; border-radius: 5px; z-index: 1000; font-size: 14px; text-align: center; }
        .notification.success { background: #4CAF50; }
        .notification.error { background: #f44336; }
        .notification.warning { background: #FF9800; }
        
        /* Tombol Absensi */
        #showAttendanceBtn { background: #3a4f41; margin-top: 10px; }
        #showAttendanceBtn:hover { background: #4a6f5a; }
        
        /* Panel Absensi */
        #attendancePanel { margin-top: 20px; background: #1d1f1d; padding: 15px; border-radius: 5px; border: 1px solid #3a4f41; }
        .attendance-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #3a4f41; }
        .attendance-filters { display: flex; gap: 10px; margin-bottom: 15px; }
        .attendance-filters select, .attendance-filters input { flex: 1; }
        .attendance-filters button { margin-top: 5px; padding: 8px 15px; width: auto; }
        .attendance-summary { background: #2a3a2e; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .progress-container { background: #333; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; background: #4CAF50; transition: width 0.3s; }
        .desa-card { background: #2a3a2e; border-radius: 5px; margin-bottom: 10px; overflow: hidden; border-left: 4px solid #4CAF50; }
        .desa-card.incomplete { border-left-color: #FF9800; }
        .desa-header { padding: 10px 15px; background: #3a4f41; display: flex; justify-content: space-between; align-items: center; }
        .desa-name { font-weight: bold; color: #9fd49f; font-size: 16px; }
        .desa-count { background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 20px; font-size: 14px; }
        .desa-files { padding: 10px 15px; max-height: 200px; overflow-y: auto; }
        .file-item { padding: 8px 0; border-bottom: 1px solid #3a4f41; }
        .file-item:last-child { border-bottom: none; }
        .file-info { display: flex; justify-content: space-between; align-items: center; }
        .file-name { font-size: 14px; color: #f5f5f5; }
        .file-meta { font-size: 12px; color: #a5a5a5; margin-top: 3px; }
        .file-link { color: #b2d8b2; text-decoration: none; margin-left: 10px; }
        .attendance-actions { display: flex; gap: 10px; margin-top: 15px; }
        .attendance-actions button { flex: 1; margin-top: 0; padding: 10px; }
        
        /* App-like Fullscreen Mode */
        @media (display-mode: standalone) {
            body {
                padding: 0;
                height: 100vh;
                overflow: hidden;
            }
            .container {
                border-radius: 0;
                max-width: 100%;
                min-height: 100vh;
                margin: 0;
                padding: 20px 15px;
            }
            /* Safe area for notches */
            .container {
                padding-top: env(safe-area-inset-top, 20px);
                padding-bottom: env(safe-area-inset-bottom, 20px);
                padding-left: env(safe-area-inset-left, 15px);
                padding-right: env(safe-area-inset-right, 15px);
            }
        }
        
        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2b4d2b 0%, #1d1f1d 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        
        .splash-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 50px;
            color: #b2d8b2;
        }
        
        .splash-text {
            color: #9fd49f;
            font-size: 18px;
            text-align: center;
            margin-top: 20px;
        }
        
        /* Install Button */
        #installButton {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        #installButton:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        @media (max-width: 480px) {
            .container { padding: 15px; }
            .header-container { flex-direction: column; text-align: center; }
            .header-image { height: 120px; width: 120px; }
            .header-title { font-size: 15px; }
            .header-subtitle { font-size: 11px; }
            button { padding: 10px; }
            .attendance-filters { flex-direction: column; }
            .attendance-actions { flex-direction: column; }
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fa-spin { animation: spin 1s infinite linear; }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen">
        <div class="splash-logo">
            <i class="fas fa-shield-alt"></i>
        </div>
        <div class="splash-text">
            DUKOPS BABINSA<br>
            <small>Memuat aplikasi...</small>
        </div>
    </div>
    
    <!-- Install Button -->
    <button id="installButton">
        <i class="fas fa-download"></i> Install App
    </button>
    
    <div class="container">
        <div style="width: 90%; margin: 0 auto; font-size: 12px;">
            <div class="header-container">
                <img id="desaHeaderImage" src="https://github.com/Koramil05/DUKOPS/blob/main/bnr_default.png?raw=true" alt="Header Desa" class="header-image" onerror="this.src='https://github.com/Koramil05/DUKOPS/blob/main/bnr_default.png?raw=true'">
                <div class="header-text">
                    <div class="header-title">DUKOPS BABINSA</div>
                    <div class="header-title">KORAMIL 1609-05/SUKASADA</div>
                    <div class="header-subtitle">Jl. Jelantik Gingsir No. 32 Sukasada Singaraja-Bali 81161</div>
                    <div><div class="counter-value" id="submissionCounter">0</div></div>
                </div>
            </div>
            
            <label><i class="fas fa-village"></i> Pilih Desa:</label>
            <select id="selectDesa" onchange="loadSelectedDesa()">
                <option value="">-- Pilih Desa --</option>
            </select>
            <div id="loadingDesa"><i class="fas fa-spinner fa-spin"></i> Memuat daftar desa/Kelurahan...</div>
            <div class="previewBox" id="previewDesa"></div>

            <div id="loadingKoordinat"><i class="fas fa-spinner fa-spin"></i> Memuat koordinat...</div>
            <div class="previewBox" id="previewKordinat"></div>

            <label><i class="fas fa-camera"></i> Foto Kegiatan:</label>
            <input type="file" id="gambar" accept="image/*" onchange="previewImage()">
            <div class="previewBox" id="previewGambar"></div>

            <label><i class="fas fa-calendar-alt"></i> Tanggal & Waktu:</label>
            <input type="datetime-local" id="tanggalWaktu" onchange="updateDatePreview()">
            <div class="previewBox" id="previewTanggal"></div>

            <label><i class="fas fa-file-alt"></i> Narasi Kegiatan:</label>
            <textarea id="narasi" rows="4" placeholder="Masukkan narasi kegiatan..." oninput="checkInputCompletion()"></textarea>

            <canvas id="canvas"></canvas>

            <button id="submitBtn" onclick="processSubmission()" disabled>
                <i class="fas fa-download"></i> DOWNLOAD & <i class="fas fa-paper-plane"></i> KIRIM & <i class="fab fa-google-drive"></i> DRIVE
            </button>
            <button id="resetBtn" onclick="resetAll()"><i class="fas fa-redo"></i> Reset Semua Data</button>
            
            <button id="showAttendanceBtn" onclick="showAttendance()">
                <i class="fas fa-chart-bar"></i> TAMPILKAN LAPORAN
            </button>

            <div id="attendancePanel" style="display: none;">
                <div class="attendance-header">
                    <h3 style="color: #9fd49f; margin: 0;"><i class="fas fa-file-alt"></i> LAPORAN TERKIRIM</h3>
                    <button onclick="hideAttendance()" style="background: transparent; border: none; color: #f5f5f5; cursor: pointer; font-size: 20px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                    
                <div class="attendance-filters">
                    <select id="attendanceDesaFilter" onchange="loadAttendanceData()">
                        <option value="">Semua Desa</option>
                    </select>
                    <input type="month" id="attendanceMonthFilter" onchange="loadAttendanceData()">
                </div>                
                
                <div id="attendanceLoading" style="display: none; text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin"></i> ðŸª– Sistem sedang menyiapkan laporan...
                </div>
                
                <div id="attendanceSummary" class="attendance-summary" style="display: none;">
                    <div class="summary-row">
                        <span>Total Laporan:</span>
                        <span id="totalReports" style="font-weight: bold; color: #9fd49f;">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Total Desa:</span>
                        <span id="totalDesa" style="font-weight: bold; color: #9fd49f;">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Pencapaian Target:</span>
                        <span id="targetStatus" style="font-weight: bold;">0%</span>
                    </div>
                    <div class="progress-container">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>
                </div>
                
                <div id="attendanceList" style="max-height: 400px; overflow-y: auto;"></div>
                
                <div class="attendance-actions">
                    <button onclick="refreshAttendanceData()" style="background: #3a4f41;">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                    <button onclick="downloadAttendanceReport()" style="background: #2b4d2b;">
                        <i class="fas fa-download"></i> Download Laporan
                    </button>
                </div>
            </div>

            <div id="logTerkirim"></div>
        </div>
    </div>

    <script>
        // ================= KONFIGURASI AMAN =================
        const GITHUB_API_URL = "https://api.github.com/repos/sukasada05/DUKOPS/contents/";
        const GOOGLE_APPS_SCRIPT_WEBHOOK = "https://script.google.com/macros/s/AKfycbweib5g7YBnC5XuguK2LTEOCPOXa3dttgATlegVtdeEU1LmcoWA1RGsxOWqeVTDoXjn/exec";
        const TARGET_LAPORAN = 9;

        // ================= VARIABEL GLOBAL =================
        let img = new Image();
        let selectedDesa = "";
        let kordinatList = [];
        let currentKoordinat = "";
        let tanggalWaktu = "";
        let submissionCount = 0;
        let submittedDates = [];
        let desaCounter = {};
        let attendanceData = [];
        let deferredPrompt = null;

        // ================= FUNGSI UTAMA =================
        function normalizeDesaName(desaName) {
            if (!desaName) return "";
            
            let normalized = desaName;
            normalized = normalized.replace(/^Desa\s+/i, '');
            normalized = normalized.replace(/^Kelurahan\s+/i, '');
            normalized = normalized.replace(/Kel\.\s*/gi, '');
            normalized = normalized.replace(/Kel\s/gi, '');
            normalized = normalized.trim();
            const forTelegram = normalized.replace(/_/g, ' ');
            
            return {
                original: desaName,
                normalized: normalized,
                forTelegram: forTelegram,
                cleanName: forTelegram.trim()
            };
        }

        // ================= FUNGSI BACKEND AMAN =================
        async function sendToBackend(action, data = {}) {
  try {
    // Untuk GET requests
    if (action === 'listFiles' || action === 'getConfig' || action === 'test' || action === 'telegramTest') {
      let url = `${GOOGLE_APPS_SCRIPT_WEBHOOK}?action=${action}`;
      
      // Tambahkan parameter untuk listFiles
      if (action === 'listFiles') {
        if (data.desaFilter) url += `&desaFilter=${encodeURIComponent(data.desaFilter)}`;
        if (data.monthFilter) url += `&monthFilter=${encodeURIComponent(data.monthFilter)}`;
      }
      
      const response = await fetch(url);
      return await response.json();
    }
    // Untuk POST requests
    else {
      const formData = new FormData();
      formData.append('action', action);
      
      // Tambahkan semua data ke formData
      Object.keys(data).forEach(key => {
        if (data[key] !== undefined && data[key] !== null) {
          if (key === 'fileData' && typeof data[key] === 'string') {
            formData.append(key, data[key]);
          } else {
            formData.append(key, String(data[key]));
          }
        }
      });
      
      const response = await fetch(GOOGLE_APPS_SCRIPT_WEBHOOK, {
        method: 'POST',
        body: formData
      });
      
      return await response.json();
    }
  } catch (error) {
    console.error(`Error in ${action}:`, error);
    return { success: false, error: error.message };
  }
}

async function uploadToGoogleDrive(zipBlob, zipFileName, desaName, date) {
  try {
    const base64Data = await blobToBase64(zipBlob);
    const desaInfo = normalizeDesaName(desaName);
    
    const result = await sendToBackend('uploadDrive', {
      fileName: zipFileName,
      desaName: desaInfo.cleanName,
      fileData: base64Data,
      year: date.getFullYear().toString(),
      month: date.toLocaleDateString('id-ID', { month: 'long' }),
      desa: desaInfo.cleanName,
      mimeType: 'application/zip'
    });
    
    return result.success === true;
  } catch (error) {
    console.error('Error upload ke Drive:', error);
    return false;
  }
}

async function sendZipToTelegram(zipBlob, filename, desaName) {
  try {
    const base64Data = await blobToBase64(zipBlob);
    const desaInfo = normalizeDesaName(desaName);
    
    const result = await sendToBackend('sendTelegram', {
      fileName: filename,
      desaName: desaInfo.cleanName,
      fileData: base64Data,
      mimeType: 'application/zip'
    });
    
    return result.success === true;
  } catch (error) {
    console.error('Error send to Telegram:', error);
    return false;
  }
}

        // Helper function
        async function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });
        }
// ======== TAMBAHKAN KODE INI DI ATAS initialize() ========
// Simpan data ke localStorage
function saveFormData() {
    const form = {
        nama: document.getElementById('nama')?.value || '',
        pangkat: document.getElementById('pangkat')?.value || '',
        desa: document.getElementById('desa')?.value || '',
        kegiatan: document.getElementById('kegiatan')?.value || ''
    };
    localStorage.setItem('dukops_draft', JSON.stringify(form));
}

// Service Worker
function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/DUKOPS/sw.js')
            .then(() => console.log('âœ… PWA Ready!'))
            .catch(e => console.log('âŒ PWA Error:', e));
    }
}

// Deteksi offline
function setupOfflineDetection() {
    if (!navigator.onLine) {
        document.body.classList.add('offline');
    }
    window.addEventListener('online', () => {
        document.body.classList.remove('offline');
    });
    window.addEventListener('offline', () => {
        document.body.classList.add('offline');
    });
    
    // Auto-save setiap 10 detik
    setInterval(saveFormData, 10000);
}
// ========================================================
        // ================= INISIALISASI =================
function initialize() {
    setTimeout(() => {
        document.getElementById('splashScreen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('splashScreen').style.display = 'none';
        }, 500);
    }, 1500);
    
    // === TAMBAH 2 BARIS INI DIBAWAH SPLASH ===
    registerServiceWorker();      // BARIS 1
    setupOfflineDetection();      // BARIS 2
    // ========================================
    
    initializeCounter();
    loadDesaList();
    loadLastSubmittedDates();
            loadDesaCounter();
            resetCanvas();
            
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            document.getElementById('tanggalWaktu').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            updateDatePreview();
            
            setupInstallPrompt();
            setupHapticFeedback();
        }

        // ================= PWA INSTALL =================
        function setupInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                setTimeout(() => {
                    const installButton = document.getElementById('installButton');
                    installButton.style.display = 'flex';
                    
                    installButton.addEventListener('click', async () => {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice;
                            if (outcome === 'accepted') {
                                installButton.style.display = 'none';
                                showNotification('âœ… Aplikasi berhasil diinstall!', 'success');
                            }
                            deferredPrompt = null;
                        }
                    });
                }, 3000);
            });
            
            window.addEventListener('appinstalled', () => {
                document.getElementById('installButton').style.display = 'none';
                deferredPrompt = null;
            });
        }

        // ================= HAPTIC FEEDBACK =================
        function setupHapticFeedback() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                });
            });
        }

        // ================= LOAD DESA LIST =================
        async function loadDesaList() {
            const select = document.getElementById('selectDesa');
            const loading = document.getElementById('loadingDesa');
            loading.style.display = 'block';
            
            try {
                const response = await fetch(GITHUB_API_URL);
                if (!response.ok) throw new Error("Gagal memuat daftar desa");
                
                const files = await response.json();
                const coordFiles = files.filter(file => 
                    file.name.startsWith('CO_') && 
                    file.name.endsWith('.txt') &&
                    file.type === 'file'
                );
                
                coordFiles.forEach(file => {
                    const rawName = file.name
                        .replace('CO_', '')
                        .replace('.txt', '')
                        .replace(/_/g, ' ');
                    
                    const desaInfo = normalizeDesaName(rawName);
                    
                    const option = document.createElement('option');
                    option.value = file.download_url;
                    option.textContent = desaInfo.cleanName;
                    option.setAttribute('data-raw-name', rawName);
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error("Error:", error);
                showNotification("Gagal memuat daftar desa", "error");
            } finally {
                loading.style.display = 'none';
            }
        }

        async function loadSelectedDesa() {
            const select = document.getElementById('selectDesa');
            const coordUrl = select.value;
            const loading = document.getElementById('loadingKoordinat');
            
            if (!coordUrl) {
                resetForm();
                return;
            }
            
            const selectedOption = select.options[select.selectedIndex];
            selectedDesa = selectedOption.getAttribute('data-raw-name') || selectedOption.text;
            
            updateDesaHeaderImage(selectedDesa);
            
            const desaInfo = normalizeDesaName(selectedDesa);
            document.getElementById('previewDesa').textContent = "Desa: " + desaInfo.cleanName;
            
            loading.style.display = 'block';
            document.getElementById('previewKordinat').textContent = "Memuat koordinat...";
            
            try {
                const response = await fetch(coordUrl);
                if (!response.ok) throw new Error("Gagal memuat koordinat");
                
                const text = await response.text();
                kordinatList = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.includes(','));
                
                if (kordinatList.length === 0) throw new Error("File koordinat kosong");
                
                pickRandomKoordinat();
                showNotification(`Koordinat ${desaInfo.cleanName} dimuat (${kordinatList.length} titik)`, "success");
                
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('previewKordinat').textContent = "Gagal memuat koordinat";
                showNotification("Gagal memuat koordinat otomatis", "error");
            } finally {
                loading.style.display = 'none';
                updatePreview();
                checkInputCompletion();
            }
        }

        function pickRandomKoordinat() {
            if (kordinatList.length === 0) {
                showNotification("Tidak ada data koordinat tersedia", "warning");
                return;
            }
            
            if (!selectedDesa) {
                showNotification("Pilih desa terlebih dahulu", "warning");
                return;
            }
            
            const coordElement = document.getElementById('previewKordinat');
            coordElement.style.transition = "opacity 0.3s";
            coordElement.style.opacity = "0";
            
            setTimeout(() => {
                const randomIndex = Math.floor(Math.random() * kordinatList.length);
                currentKoordinat = kordinatList[randomIndex];
                
                coordElement.innerHTML = '<i class="fas fa-map-marker-alt"></i> ' + currentKoordinat;
                
                setTimeout(() => {
                    coordElement.style.opacity = "1";
                }, 50);
                
                updatePreview();
                checkInputCompletion();
                
            }, 300);
        }

        // ================= FUNGSI GAMBAR =================
        function previewImage() {
            const file = document.getElementById("gambar").files[0];
            const preview = document.getElementById("previewGambar");
            
            if (file) {
                preview.textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        if (kordinatList.length > 0) {
                            pickRandomKoordinat();
                        }
                        updatePreview();
                    };
                    img.onerror = function() {
                        showNotification("Gagal memuat gambar", "error");
                        document.getElementById("gambar").value = "";
                        preview.textContent = "";
                    };
                };
                reader.onerror = function() {
                    showNotification("Gagal membaca file", "error");
                };
                reader.readAsDataURL(file);
            } else {
                img = new Image();
                updatePreview();
            }
            checkInputCompletion();
        }

        function updateDatePreview() {
            const tglInput = document.getElementById("tanggalWaktu").value;
            const preview = document.getElementById("previewTanggal");
            
            if (tglInput) {
                let date;
                
                if (tglInput.includes('T')) {
                    date = new Date(tglInput);
                } else {
                    const [datePart, timePart] = tglInput.split(' ');
                    const [year, month, day] = datePart.split('-');
                    const [hours, minutes] = timePart.split(':');
                    date = new Date(year, month - 1, day, hours, minutes);
                }
                
                date.setSeconds(Math.floor(Math.random() * 60));
                tanggalWaktu = date.toISOString();
                
                const options = {
                    weekday: 'long', 
                    day: '2-digit', 
                    month: 'long', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit'
                };
                
                if (date.toLocaleDateString) {
                    preview.textContent = date.toLocaleString('id-ID', options);
                } else {
                    preview.textContent = formatDateForOldBrowsers(date);
                }
            } else {
                tanggalWaktu = "";
                preview.textContent = "";
            }
            updatePreview();
            checkInputCompletion();
        }

        function formatDateForOldBrowsers(date) {
            const pad = num => (num < 10 ? '0' + num : num);
            return [
                pad(date.getDate()),
                pad(date.getMonth() + 1),
                date.getFullYear()
            ].join('-') + ' ' + [
                pad(date.getHours()),
                pad(date.getMinutes()),
                pad(date.getSeconds())
            ].join(':');
        }

        // ================= FUNGSI PREVIEW =================
        function updatePreview() {
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            
            if (img.src && img.complete) {
                canvas.width = 800;
                canvas.height = Math.round(canvas.width * (img.height / img.width));
            } else {
                canvas.width = 800;
                canvas.height = Math.round(canvas.width * (9/16));
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (img.src && img.complete) {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            if (selectedDesa || currentKoordinat || tanggalWaktu) {
                ctx.textAlign = "right";
                ctx.font = "36px Arial";
                
                const bottomMargin = 20;
                const lineHeight = 40;
                const rightMargin = 10;
                
                if (selectedDesa) {
                    const desaInfo = normalizeDesaName(selectedDesa);
                    const displayDesaName = desaInfo.cleanName;
                    
                    const watermarkText = (displayDesaName === "Sukasada" || displayDesaName === "SUKASADA") 
                        ? "Babinsa Kelurahan Sukasada" 
                        : "Babinsa " + displayDesaName;
                    
                    ctx.strokeStyle = "white";
                    ctx.lineWidth = 0;
                    ctx.strokeText(watermarkText, 
                                  canvas.width - rightMargin, 
                                  canvas.height - bottomMargin - (lineHeight * 2));
                    
                    ctx.fillStyle = "white";
                    ctx.fillText(watermarkText, 
                                canvas.width - rightMargin, 
                                canvas.height - bottomMargin - (lineHeight * 2));
                }
                
                if (currentKoordinat) {
                    ctx.strokeStyle = "white";
                    ctx.lineWidth = 0;
                    ctx.strokeText(currentKoordinat, 
                                  canvas.width - rightMargin, 
                                  canvas.height - bottomMargin - lineHeight);
                    
                    ctx.fillStyle = "white";
                    ctx.fillText(currentKoordinat, 
                                canvas.width - rightMargin, 
                                canvas.height - bottomMargin - lineHeight);
                }
                
                if (tanggalWaktu) {
                    const date = new Date(tanggalWaktu);
                    let dateText;
                    
                    if (date.toLocaleDateString) {
                        dateText = date.toLocaleDateString("id-ID", { 
                            day: "2-digit", 
                            month: "long", 
                            year: "numeric" 
                        }) + ", " + 
                        date.toLocaleTimeString("id-ID", { 
                            hour: "2-digit", 
                            minute: "2-digit", 
                            second: "2-digit" 
                        });
                    } else {
                        dateText = formatDateForOldBrowsers(date);
                    }
                    
                    ctx.strokeStyle = "white";
                    ctx.lineWidth = 0;
                    ctx.strokeText(dateText, 
                                  canvas.width - rightMargin, 
                                  canvas.height - bottomMargin);
                    
                    ctx.fillStyle = "white";
                    ctx.fillText(dateText, 
                                canvas.width - rightMargin, 
                                canvas.height - bottomMargin);
                }
            }
        }

        // ================= PROSES UTAMA =================
        async function processSubmission() {
            if (!validateSubmission()) return;
            
            if (isSameDateMonthSubmission()) {
                showNotification("âš  Sudah ada laporan di tanggal dan bulan yang sama!", "warning");
                return;
            }
            
            const button = document.getElementById("submitBtn");
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
            
            try {
                const canvas = document.getElementById("canvas");
                const imgData = canvas.toDataURL("image/png");
                const narasi = document.getElementById("narasi").value;
                const date = new Date(tanggalWaktu);
                
                const day = String(date.getDate()).padStart(2, '0');
                const monthNum = String(date.getMonth() + 1);
                const monthName = date.toLocaleDateString('id-ID', { month: 'long' });
                const year = date.getFullYear();
                
                const desaInfo = normalizeDesaName(selectedDesa);
                
                const fileNameInsideZipImage = `${desaInfo.cleanName} ${day} ${monthName} ${year} Dukops.png`;
                const fileNameInsideZipNarasi = `${desaInfo.cleanName} ${day} ${monthName} ${year} Narasi.txt`;
                const zipFileNameForDownload = `${desaInfo.cleanName} ${day} ${monthNum} ${year}.zip`;
                const zipFileNameForBackend = `${desaInfo.cleanName} ${day} ${monthNum} ${year}.zip`;
                
                const formattedDate = date.toLocaleDateString('id-ID', { 
                    weekday: 'long', 
                    day: '2-digit', 
                    month: 'long', 
                    year: 'numeric'
                });
                
                const narasiContent = `${formattedDate}\tBabinsa ${desaInfo.cleanName} ${narasi}`;
                
                const zip = new JSZip();
                zip.file(fileNameInsideZipNarasi, narasiContent);
                zip.file(fileNameInsideZipImage, imgData.split("base64,")[1], { base64: true });
                
                const content = await zip.generateAsync({ type: "blob" });
                
                // 1. Download ke lokal
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = zipFileNameForDownload;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // 2. Kirim ke Telegram (via backend)
                const telegramSent = await sendZipToTelegram(content, zipFileNameForBackend, selectedDesa);
                
                // 3. Upload ke Google Drive (via backend)
                const driveUploaded = await uploadToGoogleDrive(content, zipFileNameForBackend, selectedDesa, date);
                
                // 4. Update counter per desa
                const desaData = updateDesaCounter(selectedDesa, zipFileNameForBackend);
                
                // 5. Refresh data absensi
                if (document.getElementById('attendancePanel').style.display === 'block') {
                    setTimeout(() => loadAttendanceData(), 2000);
                }
                
                // 6. Notifikasi hasil
                let notificationMsg = '';
                if (telegramSent && driveUploaded) {
                    notificationMsg = `âœ” Berhasil: Telegram & Drive (${desaData.count}/9 laporan)`;
                    showNotification(notificationMsg, "success");
                } else if (telegramSent) {
                    notificationMsg = `âœ” Telegram OK (Drive gagal) (${desaData.count}/9 laporan)`;
                    showNotification(notificationMsg, "warning");
                } else if (driveUploaded) {
                    notificationMsg = `âœ” Drive OK (Telegram gagal) (${desaData.count}/9 laporan)`;
                    showNotification(notificationMsg, "warning");
                } else {
                    notificationMsg = "âš  File didownload, tapi gagal ke Telegram & Drive";
                    showNotification(notificationMsg, "error");
                }
                
                updateCounter();
                addSendLog(zipFileNameForBackend, "success", notificationMsg);
                saveSubmittedDate(tanggalWaktu);
                
            } catch (error) {
                console.error("Error:", error);
                showNotification("âŒ Gagal mengirim laporan", "error");
                const desaInfo = normalizeDesaName(selectedDesa);
                addSendLog(`${desaInfo.cleanName} - Error`, "failed", error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function validateSubmission() {
            if (!selectedDesa) {
                showNotification("Masukkan nama desa terlebih dahulu", "warning");
                return false;
            }
            
            if (!currentKoordinat) {
                showNotification("Koordinat tidak valid", "warning");
                return false;
            }
            
            if (!tanggalWaktu) {
                showNotification("Isi tanggal dan waktu", "warning");
                return false;
            }
            
            if (!img.src || !img.complete) {
                showNotification("Upload foto kegiatan", "warning");
                return false;
            }
            
            const narasi = document.getElementById("narasi").value.trim();
            if (!narasi) {
                showNotification("Isi narasi kegiatan", "warning");
                return false;
            }
            
            const desaInfo = normalizeDesaName(selectedDesa);
            const date = new Date(tanggalWaktu);
            const day = String(date.getDate()).padStart(2, '0');
            const monthName = date.toLocaleDateString('id-ID', { month: 'long' });
            const monthNum = String(date.getMonth() + 1);
            const year = date.getFullYear();
            
            let confirmMsg = `Anda yakin ingin mengirim laporan untuk ${desaInfo.cleanName}?\n\n`;
            confirmMsg += `File ZIP akan:\n`;
            confirmMsg += `1. Didownload: ${desaInfo.cleanName} ${day} ${monthNum} ${year}.zip\n`;
            confirmMsg += `2. Berisi file:\n   - ${desaInfo.cleanName} ${day} ${monthName} ${year} Dukops.png\n`;
            confirmMsg += `   - ${desaInfo.cleanName} ${day} ${monthName} ${year} Narasi.txt\n`;
            confirmMsg += `3. Dikirim ke Telegram & Drive: ${desaInfo.cleanName} ${day} ${monthNum} ${year}.zip`;
            
            return confirm(confirmMsg);
        }

        function isSameDateMonthSubmission() {
            if (!tanggalWaktu) return false;
            
            const currentDate = new Date(tanggalWaktu);
            const currentDay = currentDate.getDate();
            const currentMonth = currentDate.getMonth();
            
            return submittedDates.some(dateStr => {
                const date = new Date(dateStr);
                return date.getDate() === currentDay && date.getMonth() === currentMonth;
            });
        }

        // ================= FUNGSI BANTUAN =================
        function resetCanvas() {
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = 800;
            canvas.height = Math.round(canvas.width / (16/9));
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function resetAll() {
            if (confirm("Apakah Anda yakin ingin mereset SEMUA data?\n\nâ€¢ Counter laporan terkirim\nâ€¢ Log pengiriman\nâ€¢ Tanggal terakhir\nâ€¢ Counter per desa\nâ€¢ Form input\n\nAksi ini tidak dapat dibatalkan!")) {
                submissionCount = 0;
                document.getElementById('submissionCounter').textContent = '0';
                localStorage.setItem('dukopsSubmissionCount', '0');
                
                localStorage.removeItem('dukopsSendLogs');
                document.getElementById('logTerkirim').innerHTML = '';
                
                submittedDates = [];
                localStorage.removeItem('dukopsSubmittedDates');
                
                desaCounter = {};
                localStorage.removeItem('dukopsDesaCounter');
                
                resetForm();
                
                showNotification("Semua data telah direset", "success");
            }
        }

        function resetForm() {
            selectedDesa = "";
            kordinatList = [];
            currentKoordinat = "";
            document.getElementById('selectDesa').value = "";
            document.getElementById('previewDesa').textContent = "";
            document.getElementById('previewKordinat').textContent = "";
            document.getElementById('narasi').value = "";
            document.getElementById('gambar').value = "";
            document.getElementById('tanggalWaktu').value = "";
            document.getElementById('previewGambar').textContent = "";
            document.getElementById('previewTanggal').textContent = "";
            updateDesaHeaderImage("");
            checkInputCompletion();
            updatePreview();
            resetCanvas();
        }

        function initializeCounter() {
            const savedCount = localStorage.getItem('dukopsSubmissionCount');
            submissionCount = savedCount ? parseInt(savedCount) : 0;
            document.getElementById('submissionCounter').textContent = submissionCount;
            loadSendLogs();
        }
        
        function loadDesaCounter() {
            const savedCounter = localStorage.getItem('dukopsDesaCounter');
            desaCounter = savedCounter ? JSON.parse(savedCounter) : {};
        }

        function updateCounter() {
            submissionCount++;
            document.getElementById('submissionCounter').textContent = submissionCount;
            localStorage.setItem('dukopsSubmissionCount', submissionCount.toString());
        }

        function updateDesaCounter(desaName, fileName) {
            const date = new Date(tanggalWaktu);
            const monthYear = date.toLocaleDateString('id-ID', { 
                month: 'long', 
                year: 'numeric' 
            });
            
            if (!desaCounter[desaName]) {
                desaCounter[desaName] = {
                    count: 0,
                    files: [],
                    month: monthYear
                };
            }
            
            if (desaCounter[desaName].month !== monthYear) {
                desaCounter[desaName] = {
                    count: 1,
                    files: [fileName],
                    month: monthYear
                };
            } else {
                desaCounter[desaName].count++;
                desaCounter[desaName].files.push(fileName);
                
                if (desaCounter[desaName].files.length > TARGET_LAPORAN) {
                    desaCounter[desaName].files.shift();
                }
            }
            
            localStorage.setItem('dukopsDesaCounter', JSON.stringify(desaCounter));
            
            return desaCounter[desaName];
        }

        function addSendLog(filename, status, message = "") {
            const logsContainer = document.getElementById("logTerkirim");
            const logEntry = document.createElement("div");
            logEntry.className = "log-entry";
            
            const time = new Date().toLocaleTimeString('id-ID');
            const statusClass = status === "success" ? "success" : "failed";
            
            logEntry.innerHTML = `
                <div class="log-time">${time}</div>
                <div class="log-filename">${filename}</div>
                <div class="log-status ${statusClass}">Status: ${status.toUpperCase()} ${message}</div>
            `;
            
            logsContainer.insertBefore(logEntry, logsContainer.firstChild);
            saveSendLog(filename, status, time);
        }

        function saveSendLog(filename, status, time) {
            let logs = JSON.parse(localStorage.getItem('dukopsSendLogs') || '[]');
            logs.unshift({ filename, status, time });
            if (logs.length > 50) logs = logs.slice(0, 50);
            localStorage.setItem('dukopsSendLogs', JSON.stringify(logs));
        }

        function loadSendLogs() {
            const logs = JSON.parse(localStorage.getItem('dukopsSendLogs') || '[]');
            const container = document.getElementById("logTerkirim");
            
            logs.forEach(log => {
                const logEntry = document.createElement("div");
                logEntry.className = "log-entry";
                const statusClass = log.status === "success" ? "success" : "failed";
                
                logEntry.innerHTML = `
                    <div class="log-time">${log.time}</div>
                    <div class="log-filename">${log.filename}</div>
                    <div class="log-status ${statusClass}">Status: ${log.status.toUpperCase()}</div>
                `;
                
                container.appendChild(logEntry);
            });
        }

        function saveSubmittedDate(dateStr) {
            submittedDates.push(dateStr);
            localStorage.setItem('dukopsSubmittedDates', JSON.stringify(submittedDates));
        }

        function loadLastSubmittedDates() {
            const savedDates = localStorage.getItem('dukopsSubmittedDates');
            submittedDates = savedDates ? JSON.parse(savedDates) : [];
        }

        function checkInputCompletion() {
            const isComplete = selectedDesa && 
                             currentKoordinat && 
                             tanggalWaktu && 
                             img.src && 
                             img.complete && 
                             document.getElementById("narasi").value.trim();
            
            document.getElementById("submitBtn").disabled = !isComplete;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // ================= FUNGSI ABSENSI =================
        function showAttendance() {
            const panel = document.getElementById('attendancePanel');
            const button = document.getElementById('showAttendanceBtn');
            
            panel.style.display = 'block';
            button.style.display = 'none';
            
            populateAttendanceDesaFilter();
            
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('attendanceMonthFilter').value = `${year}-${month}`;
            
            loadAttendanceData();
        }

        function hideAttendance() {
            const panel = document.getElementById('attendancePanel');
            const button = document.getElementById('showAttendanceBtn');
            
            panel.style.display = 'none';
            button.style.display = 'block';
        }

        function populateAttendanceDesaFilter() {
            const filter = document.getElementById('attendanceDesaFilter');
            const selectDesa = document.getElementById('selectDesa');
            
            filter.innerHTML = '<option value="">Semua Desa</option>';
            
            for (let i = 1; i < selectDesa.options.length; i++) {
                const option = selectDesa.options[i];
                const desaInfo = normalizeDesaName(option.getAttribute('data-raw-name') || option.text);
                
                const newOption = document.createElement('option');
                newOption.value = desaInfo.cleanName;
                newOption.textContent = desaInfo.cleanName;
                filter.appendChild(newOption);
            }
        }

async function loadAttendanceData() {
  const loading = document.getElementById('attendanceLoading');
  const list = document.getElementById('attendanceList');
  const summary = document.getElementById('attendanceSummary');
  
  loading.style.display = 'block';
  list.innerHTML = '';
  summary.style.display = 'none';
  
  try {
    const result = await sendToBackend('listFiles', {
      desaFilter: document.getElementById('attendanceDesaFilter').value,
      monthFilter: document.getElementById('attendanceMonthFilter').value
    });
    
    if (result.success) {
      attendanceData = result.files || [];
      displayAttendanceList(attendanceData);
      displayAttendanceSummary(attendanceData);
      showNotification(`âœ… Data absensi dimuat (${attendanceData.length} file)`, "success");
    } else {
      showNotification("âŒ Gagal memuat data absensi", "error");
    }
    
  } catch (error) {
    console.error('Error loading attendance:', error);
    loadAttendanceFromFallback();
  } finally {
    loading.style.display = 'none';
  }
}

        function loadAttendanceFromFallback() {
            const list = document.getElementById('attendanceList');
            const summary = document.getElementById('attendanceSummary');
            
            const desaData = [];
            for (const [desaName, data] of Object.entries(desaCounter)) {
                if (data.files && data.files.length > 0) {
                    data.files.forEach(fileName => {
                        desaData.push({
                            name: fileName,
                            desa: desaName,
                            count: data.count,
                            month: data.month
                        });
                    });
                }
            }
            
            if (desaData.length > 0) {
                attendanceData = desaData.map(item => ({
                    name: item.name,
                    desa: item.desa,
                    size: 0,
                    createdTime: new Date().toISOString(),
                    webViewLink: '#'
                }));
                
                displayAttendanceList(attendanceData);
                displayAttendanceSummary(attendanceData);
                showNotification("Menggunakan data lokal (offline mode)", "warning");
            } else {
                list.innerHTML = `<div style="text-align: center; color: #a5a5a5; padding: 20px;">
                    <i class="fas fa-folder-open"></i><br>
                    Tidak ada data laporan<br>
                    <small>Silakan kirim laporan terlebih dahulu</small>
                </div>`;
                summary.style.display = 'none';
            }
        }

        function displayAttendanceList(files) {
            const list = document.getElementById('attendanceList');
            
            if (!files || files.length === 0) {
                list.innerHTML = `<div style="text-align: center; color: #a5a5a5; padding: 20px;">
                    <i class="fas fa-folder-open"></i><br>
                    Tidak ada data laporan<br>
                    <small>Silakan kirim laporan terlebih dahulu</small>
                </div>`;
                return;
            }
            
            const groupedByDesa = {};
            files.forEach(file => {
                const desaName = file.desa || extractDesaFromFileName(file.name);
                if (!groupedByDesa[desaName]) {
                    groupedByDesa[desaName] = [];
                }
                groupedByDesa[desaName].push(file);
            });
            
            const sortedDesas = Object.keys(groupedByDesa).sort((a, b) => {
                return groupedByDesa[b].length - groupedByDesa[a].length;
            });
            
            let html = '';
            
            sortedDesas.forEach(desaName => {
                const desaFiles = groupedByDesa[desaName];
                const count = desaFiles.length;
                const isComplete = count >= TARGET_LAPORAN;
                
                html += `
                    <div class="desa-card ${isComplete ? '' : 'incomplete'}">
                        <div class="desa-header">
                            <div class="desa-name">${desaName}</div>
                            <div class="desa-count" style="color: ${isComplete ? '#4CAF50' : '#FF9800'}">
                                ${count}/${TARGET_LAPORAN} laporan
                            </div>
                        </div>
                        <div class="desa-files">
                `;
                
                desaFiles.sort((a, b) => new Date(b.createdTime) - new Date(a.createdTime));
                
                desaFiles.forEach((file, index) => {
                    const date = new Date(file.createdTime);
                    const dateStr = date.toLocaleDateString('id-ID', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const fileSize = file.size ? formatFileSize(file.size) : 'Ukuran tidak tersedia';
                    
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <div style="flex: 1;">
                                    <div class="file-name">${file.name}</div>
                                    <div class="file-meta">
                                        <i class="far fa-clock"></i> ${dateStr}
                                        <span style="margin-left: 10px;">
                                            <i class="fas fa-hdd"></i> ${fileSize}
                                        </span>
                                    </div>
                                </div>
                                ${file.webViewLink !== '#' ? `
                                    <a href="${file.webViewLink}" target="_blank" class="file-link" title="Buka di Drive">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        function displayAttendanceSummary(files) {
            const summary = document.getElementById('attendanceSummary');
            const totalReports = document.getElementById('totalReports');
            const totalDesa = document.getElementById('totalDesa');
            const targetStatus = document.getElementById('targetStatus');
            const progressBar = document.getElementById('progressBar');
            
            if (!files || files.length === 0) {
                summary.style.display = 'none';
                return;
            }
            
            summary.style.display = 'block';
            
            totalReports.textContent = files.length;
            
            const uniqueDesas = new Set();
            files.forEach(file => {
                const desaName = file.desa || extractDesaFromFileName(file.name);
                uniqueDesas.add(desaName);
            });
            
            totalDesa.textContent = uniqueDesas.size;
            
            let totalAchieved = 0;
            let totalPossible = uniqueDesas.size * TARGET_LAPORAN;
            
            const desaCounts = {};
            files.forEach(file => {
                const desaName = file.desa || extractDesaFromFileName(file.name);
                desaCounts[desaName] = (desaCounts[desaName] || 0) + 1;
            });
            
            Object.values(desaCounts).forEach(count => {
                totalAchieved += Math.min(count, TARGET_LAPORAN);
            });
            
            const achievementPercent = totalPossible > 0 ? (totalAchieved / totalPossible * 100) : 0;
            
            targetStatus.textContent = `${achievementPercent.toFixed(1)}%`;
            targetStatus.style.color = achievementPercent >= 100 ? '#4CAF50' : 
                                       achievementPercent >= 70 ? '#FF9800' : '#f44336';
            
            progressBar.style.width = `${achievementPercent}%`;
            progressBar.style.background = achievementPercent >= 100 ? '#4CAF50' : 
                                           achievementPercent >= 70 ? '#FF9800' : '#f44336';
        }

        function extractDesaFromFileName(filename) {
            const cleanName = filename.replace(/_/g, ' ')
                                     .replace(/\.zip$/, '')
                                     .replace(/\s+\d{2}\s+\d{2}\s+\d{4}.*$/, '')
                                     .trim();
            
            const selectDesa = document.getElementById('selectDesa');
            for (let i = 1; i < selectDesa.options.length; i++) {
                const option = selectDesa.options[i];
                const desaInfo = normalizeDesaName(option.getAttribute('data-raw-name') || option.text);
                
                if (cleanName.toLowerCase().includes(desaInfo.cleanName.toLowerCase()) || 
                    desaInfo.cleanName.toLowerCase().includes(cleanName.toLowerCase())) {
                    return desaInfo.cleanName;
                }
            }
            
            return cleanName;
        }

        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function refreshAttendanceData() {
            loadAttendanceData();
        }

        function downloadAttendanceReport() {
            if (attendanceData.length === 0) {
                showNotification("Tidak ada data untuk didownload", "warning");
                return;
            }
            
            try {
                let txtContent = "=".repeat(50) + "\n";
                txtContent += "       LAPORAN ABSENSI DUKOPS BABINSA\n";
                txtContent += "       KORAMIL 1609-05/SUKASADA\n";
                txtContent += "=".repeat(50) + "\n\n";
                
                txtContent += `Tanggal Laporan: ${new Date().toLocaleString('id-ID')}\n`;
                txtContent += `Total Data: ${attendanceData.length} laporan\n\n`;
                
                txtContent += "-".repeat(50) + "\n";
                txtContent += "RINGKASAN PER DESA:\n";
                txtContent += "-".repeat(50) + "\n";
                
                const desaGroups = {};
                attendanceData.forEach(file => {
                    const desaName = file.desa || extractDesaFromFileName(file.name);
                    if (!desaGroups[desaName]) {
                        desaGroups[desaName] = {
                            files: [],
                            count: 0,
                            latestDate: new Date(0)
                        };
                    }
                    desaGroups[desaName].files.push(file);
                    desaGroups[desaName].count++;
                    
                    const fileDate = new Date(file.createdTime);
                    if (fileDate > desaGroups[desaName].latestDate) {
                        desaGroups[desaName].latestDate = fileDate;
                    }
                });
                
                const sortedDesas = Object.keys(desaGroups).sort((a, b) => {
                    return desaGroups[b].count - desaGroups[a].count;
                });
                
                sortedDesas.forEach((desaName, index) => {
                    const group = desaGroups[desaName];
                    const status = group.count >= TARGET_LAPORAN ? "âœ… TUNTAS" : "â³ BELUM";
                    const lastDate = group.latestDate.toLocaleDateString('id-ID');
                    
                    txtContent += `\n${index + 1}. ${desaName}\n`;
                    txtContent += `   Jumlah Laporan : ${group.count}/${TARGET_LAPORAN}\n`;
                    txtContent += `   Status Target  : ${status}\n`;
                    txtContent += `   Terakhir Kirim : ${lastDate}\n`;
                });
                
                const uniqueDesas = Object.keys(desaGroups).length;
                const totalReports = attendanceData.length;
                const completedDesas = Object.values(desaGroups).filter(g => g.count >= TARGET_LAPORAN).length;
                const completionRate = ((completedDesas / uniqueDesas) * 100).toFixed(1);
                
                txtContent += "\n" + "=".repeat(50) + "\n";
                txtContent += "STATISTIK:\n";
                txtContent += "=".repeat(50) + "\n";
                txtContent += `Total Desa        : ${uniqueDesas}\n`;
                txtContent += `Total Laporan     : ${totalReports}\n`;
                txtContent += `Desa Tuntas       : ${completedDesas}\n`;
                txtContent += `Desa Belum Tuntas : ${uniqueDesas - completedDesas}\n`;
                txtContent += `Persentase Tuntas : ${completionRate}%\n\n`;
                
                txtContent += "-".repeat(50) + "\n";
                txtContent += "DETAIL LAPORAN:\n";
                txtContent += "-".repeat(50) + "\n";
                
                attendanceData.forEach((file, index) => {
                    const date = new Date(file.createdTime);
                    const dateStr = date.toLocaleDateString('id-ID', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    txtContent += `\n${index + 1}. ${file.name}\n`;
                    txtContent += `   Desa    : ${file.desa || extractDesaFromFileName(file.name)}\n`;
                    txtContent += `   Tanggal : ${dateStr}\n`;
                    if (file.webViewLink && file.webViewLink !== '#') {
                        txtContent += `   Link    : ${file.webViewLink}\n`;
                    }
                });
                
                txtContent += "\n" + "=".repeat(50) + "\n";
                txtContent += "CATATAN:\n";
                txtContent += "- Target per desa: 9 laporan per bulan\n";
                txtContent += "- Sistem by: Serka I Nyoman Arta\n";
                txtContent += "=".repeat(50);
                
                const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                
                const now = new Date();
                const fileName = `LAPORAN_DUKOPS_${now.getDate()}_${now.getMonth() + 1}_${now.getFullYear()}.txt`;
                
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`âœ… Laporan TXT berhasil didownload: ${fileName}`, "success");
                
            } catch (error) {
                console.error('Error downloading report:', error);
                showNotification("âŒ Gagal membuat laporan", "error");
            }
        }

        function updateDesaHeaderImage(desaName) {
            const headerImage = document.getElementById('desaHeaderImage');
            if (!desaName) {
                headerImage.src = 'https://github.com/Koramil05/DUKOPS/blob/main/bnr_default.png?raw=true';
                return;
            }
            
            const desaInfo = normalizeDesaName(desaName);
            const imageName = desaInfo.normalized.toLowerCase().replace(/\s+/g, '_');
            headerImage.src = `https://github.com/Koramil05/DUKOPS/blob/main/bnr_${imageName}.png?raw=true`;
        }

        // ================= START =================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>